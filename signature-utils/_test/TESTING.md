# Cross-Language Testing Guide

This document describes how to run cross-language tests to verify that signatures generated in one language can be validated by all other language implementations.

## Overview

The cross-language tests ensure that:
1. Each language implementation generates valid signatures
2. Signatures generated by one language can be validated by all other languages
3. All implementations handle the same test data consistently
4. JSON serialization produces identical results across languages

## Test Data

The test suite uses `_test/test-data.json` which contains:
- Multiple test cases with different data structures
- Fixed timestamps for reproducible results
- Integration IDs and secret keys for each test case

## Running Tests

### Quick Start - All Languages

Run the master test script to execute tests for all available languages:

```bash
./_test/run-cross-language-tests.sh
```

This script will:
- Detect which languages are available on your system
- Run tests for each available language
- Generate signature files for cross-validation
- Provide a summary of results

### Individual Language Tests

#### JavaScript/Node.js
```bash
node _test/cross-language-test.js
```

#### Python
```bash
python3 _test/cross_language_test.py
```

#### PHP
```bash
php _test/cross_language_test.php
```

#### TypeScript
```bash
cd typescript
tsc typescript.ts
# Then create and run a test file similar to JavaScript
```

#### Other Languages
Test implementations for Go, Java, C#, Ruby, and Rust are planned but not yet implemented.

## Test Process

1. **Generation Phase**: Each language generates signatures for the test cases using fixed timestamps
2. **Self-Validation**: Each language validates its own generated signatures
3. **Cross-Validation**: Each language attempts to validate signatures generated by other languages
4. **Results**: Generated signatures are saved to `{language}-generated-signatures.json` in the `_test` directory

## Expected Results

### Signature Format
All languages should generate signatures in the format:
```
${integrationId}.${timestamp}.${hash}
```

### Cross-Validation
- Signatures generated by Language A should be valid when validated by Language B
- All languages should produce identical signatures for identical input data
- Timestamp tolerance allows for minor timing differences

## Test Cases

### Test Case 1: Simple Object
```json
{
  "userId": "12345",
  "action": "create_booking"
}
```

### Test Case 2: Complex Nested Object
```json
{
  "user": {
    "id": "67890",
    "name": "John Doe",
    "preferences": {
      "notifications": true,
      "theme": "dark"
    }
  },
  "booking": {
    "location": "parking_lot_a",
    "duration": 120,
    "features": ["covered", "electric_charging"]
  }
}
```

### Test Case 3: Array with Mixed Types
```json
{
  "items": [
    {"id": 1, "name": "Item A"},
    {"id": 2, "name": "Item B"}
  ],
  "total": 2,
  "active": true
}
```

## Troubleshooting

### Common Issues

1. **Timestamp Differences**: Tests use fixed timestamps to ensure reproducible results
2. **JSON Key Ordering**: All implementations sort JSON keys before hashing
3. **Character Encoding**: All implementations use UTF-8 encoding
4. **Hash Algorithm**: All implementations use HMAC-SHA256

### Debugging

If cross-validation fails:
1. Check that JSON serialization produces identical output
2. Verify timestamp handling (milliseconds vs seconds)
3. Ensure HMAC-SHA256 implementation is correct
4. Validate key sorting implementation

## Adding New Language Tests

To add tests for a new language:

1. Create a test file in the `_test` directory
2. Load test data from `_test/test-data.json`
3. Generate signatures using fixed timestamps
4. Validate own signatures
5. Attempt to validate signatures from other languages
6. Save generated signatures to `_test/{language}-generated-signatures.json`
7. Update the master test runner script

## Requirements

Each language test should:
- Use the same test data
- Generate reproducible signatures with fixed timestamps
- Validate signatures with appropriate tolerance
- Save results in the expected JSON format
- Handle errors gracefully
- Provide clear pass/fail indicators
